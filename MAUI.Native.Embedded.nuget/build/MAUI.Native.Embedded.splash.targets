<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <BuildNativeEmbedded>$(BuildNativeEmbedded);Splash</BuildNativeEmbedded>
    <_InitNativeEmbeddedDependsOn>
      $(_InitNativeEmbeddedDependsOn);
      _InitSplash;
    </_InitNativeEmbeddedDependsOn>
    <_SplashAssetsiOS>Splash.xcassets</_SplashAssetsiOS>
  </PropertyGroup>


  <Target Name="_InitSplash" Condition="$(BuildNativeEmbedded.Contains('Splash'))">
    <PropertyGroup>
      <ProcessNativeSplashDependsOn>
        $(ProcessNativeSplashDependsOn);
        _ProcessNativeSplash;
      </ProcessNativeSplashDependsOn>

      <ResizetizeDependsOnTargets>
        $(ResizetizeDependsOnTargets);
        ProcessNativeSplash;
      </ResizetizeDependsOnTargets>
    </PropertyGroup>

    <PrepareMauiNativeSplashScreen MauiSplashScreen="@(MauiSplashScreen)">
      <Output TaskParameter="MauiNativeSplashScreen" ItemName="_MauiNativeSplashScreen" />
    </PrepareMauiNativeSplashScreen>

    <ItemGroup Condition="'@(_MauiNativeSplashScreen)' != ''">
      <MauiSplashScreen>
        <!-- We want transparent background on splash screen images -->
        <Color>#00000000</Color>
        <!-- We want the name of the generated splash images to be "splash???" -->
        <Link>splash%(Extension)</Link>
      </MauiSplashScreen>

      <_MauiNativeSplashAssets
        Condition="'$(_ResizetizerIsiOSApp)' == 'True' AND '$(TargetPlatformIdentifier)' != 'maccatalyst'"
        Include="$(MSBuildThisFileDirectory)/../platform/ios/Splash.*/**/*" />

      <_MauiNativeSplashAssets
        Condition="'$(_ResizetizerIsAndroidApp)' == 'true'"
        Include="$(MSBuildThisFileDirectory)/../platform/Android/Resources/**/splash*" />
    </ItemGroup>

    <Copy
      SourceFiles="@(_MauiNativeSplashAssets)"
      DestinationFolder="$(_MauiIntermediateSplashScreen)/%(_MauiNativeSplashAssets.RecursiveDir)"
      SkipUnchangedFiles="false">
      <Output TaskParameter="CopiedFiles" ItemName="_CopiedMauiNativeSplashAssets" />
    </Copy>

    <ItemGroup>
      <_CopiedMauiNativeSplashAssets>
        <Color>%(_MauiNativeSplashScreen.Color)</Color>
        <DarkColor>%(_MauiNativeSplashScreen.DarkColor)</DarkColor>
      </_CopiedMauiNativeSplashAssets>
    </ItemGroup>


    <!-- iOS, but not Catalyst -->
    <UpdateXCAssetsColorset
      Condition="'$(_ResizetizerIsiOSApp)' == 'true' AND '$(TargetPlatformIdentifier)' != 'maccatalyst' AND '@(_CopiedMauiNativeSplashAssets)' != ''"
      Items="@(_CopiedMauiNativeSplashAssets)"
      Color="%(_CopiedMauiNativeSplashAssets.Color)"
      DarkColor="%(_CopiedMauiNativeSplashAssets.DarkColor)" />

  </Target>

  <Target Name="_ProcessNativeSplash" Condition="'@(_MauiNativeSplashScreen)' != ''">

    <ItemGroup>
      <_MauiNativeSplashScreenDarkTint Include="@(_MauiNativeSplashScreen)">
        <Color>#00000000</Color>
        <TintColor Condition="'%(_MauiNativeSplashScreen.DarkTintColor)' != ''">%(_MauiNativeSplashScreen.DarkTintColor)</TintColor>
        <InputsFileHash>dark</InputsFileHash>
        <Link>splash%(Extension)</Link>
      </_MauiNativeSplashScreenDarkTint>
    </ItemGroup>

    <!-- Android -->
    <GenerateSplashAndroidResources
      Condition="'$(_ResizetizerIsAndroidApp)' == 'true'"
      MauiSplashScreen="@(_MauiNativeSplashScreenDarkTint)"
      IntermediateOutputPath="$(MauiNativeAssetsPathRoot)/splash-night" />

    <ItemGroup Condition="'$(_ResizetizerIsAndroidApp)' == 'true'">
      <_MauiNativeGenerateSplashAndroidResources Include="$(MauiNativeAssetsPathRoot)/splash-night/**/*.png" />
      <_MauiNativeGenerateSplashAndroidResources>
        <TargetName>$([System.String]::Copy('%(RecursiveDir)').Replace('drawable-', 'drawable-night-'))%(Filename)%(Extension)</TargetName>
      </_MauiNativeGenerateSplashAndroidResources>

      <_MauiNativeSplashStyleColors Include="$(_MauiIntermediateSplashScreen)/**/maui_colors.xml" />
      <_MauiNativeSplashStyleColors Include="$(_MauiIntermediateSplashScreen)/**/splash.xml" />
      <_MauiNativeSplashStyleColors>
        <Color>%(_MauiNativeSplashScreen.Color)</Color>
        <DarkColor>%(_MauiNativeSplashScreen.DarkColor)</DarkColor>
      </_MauiNativeSplashStyleColors>
      <_MauiNativeSplashDrawableImages Include="$(_MauiIntermediateSplashScreen)/**/maui_splash_image.xml" />
    </ItemGroup>

    <Copy
      Condition="'@(_MauiNativeGenerateSplashAndroidResources)' != ''"
      SourceFiles="@(_MauiNativeGenerateSplashAndroidResources)"
      DestinationFiles="$(_MauiIntermediateSplashScreen)/%(TargetName)" />

    <XmlPoke
      Condition="'%(_MauiNativeSplashStyleColors.Filename)' == 'maui_colors'"
      XmlInputPath="%(_MauiNativeSplashStyleColors.Identity)"
      Query="//color[@name='maui_splash_color']"
      Value="%(_MauiNativeSplashStyleColors.Color)" />

    <XmlPoke
      Condition="'%(_MauiNativeSplashStyleColors.Filename)' == 'splash'"
      XmlInputPath="%(_MauiNativeSplashStyleColors.Identity)"
      Query="//color[@name='maui_splash_color']"
      Value="%(_MauiNativeSplashStyleColors.DarkColor)" />

    <!-- iOS, but not Catalyst -->
    <GenerateSplashStoryboard
      Condition="'$(_ResizetizerIsiOSApp)' == 'True' and '$(TargetPlatformIdentifier)' != 'maccatalyst'"
      IntermediateOutputPath="$(_MauiIntermediateSplashScreen)"
      MauiSplashScreen="@(_MauiNativeSplashScreenDarkTint)" />

    <ItemGroup Condition="'$(_ResizetizerIsiOSApp)' == 'True' and '$(TargetPlatformIdentifier)' != 'maccatalyst'">
      <!-- First we include the darkmode images -->
      <_MauiNativeSplashImageAssets Include="$(_MauiIntermediateSplashScreen)/**/*_dark*.png" />
      <_MauiNativeSplashImageAssets TargetName="%(Filename)%(Extension)" />
      <!-- Now we include "normal" generated images -->
      <_MauiNativeSplashImageAssets Include="$(_MauiIntermediateSplashScreen)/**/*$(_MauiSplashInputsFileHash)*.png" />
      <_MauiNativeSplashImageAssets Condition="'%(_MauiNativeSplashImageAssets.TargetName)' == ''" TargetName="$([System.Text.RegularExpressions.Regex]::Replace('%(Filename)','^[^@]+','splash'))%(Extension)" />
    </ItemGroup>

    <Copy
      Condition="'@(_MauiNativeSplashImageAssets)' != ''"
      SourceFiles="@(_MauiNativeSplashImageAssets)"
      DestinationFiles="$(MauiNativeAssetsPathRoot)/$(_SplashAssetsiOS)/Splash.imageset/%(TargetName)" />

    <ReplaceInFile
      Items="@(_MauiSplashStoryboard)"
      Pattern="&lt;color\s+key=&quot;backgroundColor&quot;\s+.*?/&gt;"
      Replacement="&lt;color key=&quot;backgroundColor&quot; name=&quot;SplashBackground&quot;/&gt;" />

    <XmlPoke
      Condition="'@(_MauiSplashStoryboard)' != ''"
      XmlInputPath="%(_MauiSplashStoryboard.Identity)"
      Query="//imageView[@image='splash_dark.png']/@image"
      Value="Splash" />

    <ItemGroup Condition="'$(_ResizetizerIsiOSApp)' == 'true' AND '$(TargetPlatformIdentifier)' != 'maccatalyst'">
      <_MauiNativeSplashCollectedAssets Include="$(MauiNativeAssetsPathRoot)/$(_SplashAssetsiOS)/**/*" />
      <_MauiNativeSplashCollectedAssets>
        <LocalDefiningProjectFullPath>%(DefiningProjectFullPath)</LocalDefiningProjectFullPath>
        <LocalMSBuildProjectFullPath>$(MSBuildProjectFullPath)</LocalMSBuildProjectFullPath>
      </_MauiNativeSplashCollectedAssets>

      <!-- Use ImageAsset to ensure that it goes into Assets.car -->
      <ImageAsset Include="@(_MauiNativeSplashCollectedAssets)" />
    </ItemGroup>
  </Target>


  <Target Name="ProcessNativeSplash" DependsOnTargets="$(ProcessNativeSplashDependsOn)" />

</Project>