<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <BuildNativeEmbedded>$(BuildNativeEmbedded);AppClips</BuildNativeEmbedded>
    <_InitNativeEmbeddedDependsOn>
      $(_InitNativeEmbeddedDependsOn);
      _InitAppClips;
    </_InitNativeEmbeddedDependsOn>
  </PropertyGroup>


  <Target Name="_InitAppClips" Condition="'@(AppClips)' != ''">
    <PropertyGroup Condition="'$(TargetPlatformIdentifier)' == 'ios' AND $(BuildNativeEmbedded.Contains('AppClips'))">
      <_ResolveNativeEmbeddedDependsOn>
        $(_ResolveNativeEmbeddedDependsOn);
        _ResolveAppClips;
      </_ResolveNativeEmbeddedDependsOn>

      <_ProcessNativeEmbeddedDependsOn>
        $(_ProcessNativeEmbeddedDependsOn);
        ProcessAppClips;
      </_ProcessNativeEmbeddedDependsOn>

      <ProcessAppClipsDependsOn>
        $(ProcessAppClipsDependsOn);
      </ProcessAppClipsDependsOn>

      <VerifyNativeEmbeddedDependsOn>
        $(VerifyNativeEmbeddedDependsOn);
        VerifyAppClips;
      </VerifyNativeEmbeddedDependsOn>
    </PropertyGroup>
  </Target>


  <Target Name="_ResolveAppClips">
    <Error Condition="Exists('%(AppClips.FullPath)') == 'false'" Code="NE0404" Text="AppClips project not found: '%(AppClips.Identity)'" />

    <ItemGroup>
      <AppClips>
        <!-- Mark this as an AppClips project so we can identyfy it later on  -->
        <IsAppClips>true</IsAppClips>
      </AppClips>

      <!-- Consolidate all included Xcode projects                            -->
      <XcodeProjects Include="@(AppClips)" />
    </ItemGroup>
  </Target>


  <Target Name="ProcessAppClips" DependsOnTargets="$(ProcessAppClipsDependsOn)" Condition="'@(AppClips)' != ''">
    <ItemGroup>
      <!-- Transferthe AppClips items back from XcodeProjects                 -->
      <AppClips Remove="@(AppClips)" />
      <AppClips Include="@(XcodeProjects)" Condition="'%(XcodeProjects.IsAppClips)' == 'true'" />
    </ItemGroup>

    <ItemGroup>
      <_AppClipsFiles Include="%(AppClips.ArchivePath)/**/*.app/AppClips/**" />
      <_AppClipsFiles>
        <TargetPath>$([System.Text.RegularExpressions.Regex]::Replace('%(_AppClipsFiles.FullPath)', '^.*[\\/]AppClips[\\/]', ''))</TargetPath>
      </_AppClipsFiles>
      <_AppClipsInfoPList Include="%(_AppClipsFiles.FullPath)" Condition="'%(_AppClipsFiles.Filename)%(_AppClipsFiles.Extension)' == 'Info.plist'" />
    </ItemGroup>

    <Error Condition="'@(_AppClipsFiles)' == ''" Code="NE0404" Text="No AppClips found in Xcode project: '%(AppClips.Identity)'" />

    <!-- Extract the bundle identifier from the AppClips found                -->
    <ReadAppManifest AppManifest="@(_AppClipsInfoPList)" TargetFrameworkMoniker="$(_ComputedTargetFrameworkMoniker)">
      <Output TaskParameter="CFBundleIdentifier" ItemName="_AppClipsIdentifiers" />
    </ReadAppManifest>

    <ItemGroup>
      <!-- Add the bundle identifiers to the entitlements of the app          -->
      <CustomEntitlements
        Include="com.apple.developer.associated-appclip-app-identifiers"
        Type="StringArray"
        Value="@(_AppClipsIdentifiers -> '$(_AppIdentifierPrefix)%(Identity)', ';')" />

      <!-- Include the found AppClips in the MAUI app                         -->
      <MauiAsset Include="@(_AppClipsFiles)" LogicalName="AppClips/%(_AppClipsFiles.TargetPath)" />
    </ItemGroup>
  </Target>


  <Target Name="VerifyAppClips" Condition="'@(AppClips)' != ''">
    <ItemGroup>
      <AppClipsTarget Condition="'%(AppClips.SkipValidation)' != 'true'" Include="$(AppBundleDir)" />
      <AppClipsTarget Condition="'%(AppClips.SkipValidation)' != 'true' AND '@(AppClipsTarget)' == ''" Include="%(AppClips.ArchivePath)" />
      <_AppClipsMobileProvisioning Condition="'@(AppClipsTarget)' != ''" Include="%(AppClipsTarget.FullPath)/**/AppClips/**/embedded.mobileprovision" />
    </ItemGroup>

    <Exec
      Condition="'@(_AppClipsMobileProvisioning)' != ''"
      Command="xcrun security cms -D -i '%(_AppClipsMobileProvisioning.FullPath)' | xcrun plutil -extract 'Entitlements.com\.apple\.developer\.parent-application-identifiers' xml1 -o - - | grep -q '$(ApplicationId)&lt;'"
      IgnoreExitCode="true"
      StandardOutputImportance="Low">
      <Output TaskParameter="ExitCode" PropertyName="ExitCode" />
    </Exec>

    <Error
      Condition="'$(ExitCode)' != '' AND '$(ExitCode)' != '0'"
      Code="NE1013"
      Text="AppClips 'com.apple.developer.parent-application-identifiers' does not match this 'ApplicationId': $(ApplicationId)" />
  </Target>


  <!-- This target is for debug purposes. See README.md for information -->
  <Target Name="BuildAppClips">
    <PropertyGroup>
      <BuildNativeEmbedded>AppClips</BuildNativeEmbedded>
    </PropertyGroup>
    <CallTarget Targets="_InitAppClips;_ProcessNativeEmbedded;VerifyNativeEmbedded" />
  </Target>

</Project>